<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>동물병원 현황</title>
    <link rel="stylesheet" href="/assets/css/main.css">
    
    <!-- 네이버 지도 API 스크립트 -->
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=네이버API코드넣기"></script>
    
    <style>
        /* 병원 목록 스타일 */
        #hospital-list {
            width: 30%;
            float: right;
            overflow-y: auto;
            max-height: 500px;
            padding: 10px;
            border-left: 1px solid #f80909;
        }

        #hospital-list ul {
            list-style: none;
            padding: 0;
        }

        #hospital-list li {
            margin-bottom: 15px;
            padding: 10px;
            cursor: pointer;
            color: black; /* 글자색을 검은색으로 설정 */
            font-size: 14px; /* 글자 크기 설정 */
        }

        #hospital-list li:hover {
            background-color: #f81212;
        }

        /* 지도 스타일 */
        #map {
            width: 70%;
            height: 500px;
            float: left;
        }

        /* 메인 컨텐츠 높이 조절 */
        #main {
            overflow: hidden;
            padding-bottom: 20px;
        }

        /* 날짜 설정 스타일 */
        #date-controls {
            margin-bottom: 20px;
        }

        /* 인포윈도우 스타일 */
        .info-window-content {
            color: black; /* 인포윈도우 글자색도 검은색으로 설정 */
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="wrapper">

     
			<!-- Header -->
            <header id="header" class="alt">
				<a href="/index/index.html" class="logo">
				  <img src="/images/logo.PNG" alt="Dr.Petper Logo" class="logo-image" />
				  <span>Dr.petper</span>
				</a>
				<nav>
				  <a href="#mypage">마이페이지</a>
				  <a href="#menu">메뉴</a>
				</nav>
			  </header>
	

			</header>
	
			<!-- Menu -->
			<nav id="menu">
				<ul class="links">
					<li><a href="/index/index.html">홈</a></li>
					<li><a href="/index/status.html">응급실 현황</a></li>
					<li><a href="/index/Adoption.html">입양대상동물</a></li>
					<li><a href="/index/Information.html">정보제공</a></li>
					<li><a href="/index/Announcement.html">공지사항</a></li>
					<li><a href="/index/board.html">게시판</a></li>

				
					<!-- 관리자 페이지 링크 (로그인 시 표시됨) -->
					<li id="admin-link" style="display:none;"><a href="/index/admin.html">관리자 페이지</a></li>
				</ul>
				<ul class="actions stacked">
					<!-- 로그인/로그아웃 버튼 -->
					<li id="login-link"><a href="/index/login.html" class="button fit">로그인</a></li>
					<li id="logout-link" style="display:none;"><a href="#" class="button fit">로그아웃</a></li>
					<li><a href="/index/register.html" class="button primary fit">회원가입</a></li>
				</ul>
			</nav>


        <!-- Main Content -->
        <section id="main" class="major">
            <div class="inner">
                <header class="major">
                    <h1>동물 응급실 현황</h1>
                </header>

                <!-- 날짜 설정 -->
                <div id="date-controls">
                    <label for="selectDate">날짜 설정:</label>
                    <input type="date" id="selectDate">
                    <button id="applyDateBtn">적용</button>
                </div>

                <div id="map"></div>

                <div id="hospital-list">
                    <h3>영업 중인 동물병원 목록</h3>
                    <ul id="hospital-list-items">
                        <!-- 병원 목록이 여기 추가됩니다 -->
                    </ul>
                    <h3>영업 종료된 병원 목록</h3>
                    <ul id="closed-hospital-list-items">
                        <!-- 영업 종료된 병원 목록 -->
                    </ul>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer id="footer">
            <div class="inner">
                <ul class="copyright">
                    <li>&copy; 펫119 동물 응급 클리닉</li><li>디자인: <a href="https://html5up.net">HTML5 UP</a></li>
                </ul>
            </div>
        </footer>

    </div>

    <!-- JavaScript -->
    <script>
        const serviceKey = 'api키넣는곳';  // 발급받은 인증키
        const apiUrl = `https://apis.data.go.kr/6310000/petsHospital/getPetHospitalList?numOfRows=100&pageNo=1&serviceKey=${encodeURIComponent(serviceKey)}`;

        var map = new naver.maps.Map('map', {
            center: new naver.maps.LatLng(35.5383773, 129.3113596),  // 울산 좌표
            zoom: 12
        });

        var markers = [], infoWindows = [];
        const hospitalList = document.getElementById('hospital-list-items');
        const closedHospitalList = document.getElementById('closed-hospital-list-items');

        const selectDateElement = document.getElementById('selectDate');
        const applyDateBtn = document.getElementById('applyDateBtn');

        // 병원 영업 여부 판단
        function isOpen(hospital, date) {
            const wkdBsn = hospital.getElementsByTagName("wkdBsn")[0].textContent;
            const wknBsn = hospital.getElementsByTagName("wknBsn")[0].textContent;
            const currentDay = new Date(date).getDay();  // 일요일(0)~토요일(6)
            
            // 영업 시간이 '-'로 되어있는 경우 처리
            if (wkdBsn === '-' || wknBsn === '-') return false;

            const openTime = currentDay === 0 || currentDay === 6 ? wknBsn : wkdBsn;
            return openTime.includes('-') ? false : true; // 날짜 기준으로 영업 여부만 체크
        }

        // 동물병원 API 호출
        fetch(apiUrl)
            .then(response => response.text())  // XML 응답을 텍스트로 받음
            .then(data => {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(data, "application/xml");

                const resultCode = xmlDoc.getElementsByTagName("resultCode")[0].textContent;
                const totalCount = xmlDoc.getElementsByTagName("totalCount")[0].textContent;

                if (resultCode === "00" && totalCount > 0) {
                    const hospitals = xmlDoc.getElementsByTagName("list");

                    for (let i = 0; i < hospitals.length; i++) {
                        const hospital = hospitals[i];
                        const lat = parseFloat(hospital.getElementsByTagName("lat")[0].textContent);
                        const lng = parseFloat(hospital.getElementsByTagName("lng")[0].textContent);
                        const facility = hospital.getElementsByTagName("facility")[0].textContent;
                        const address = hospital.getElementsByTagName("address")[0].textContent;
                        const tel = hospital.getElementsByTagName("tel")[0].textContent;
                        const wkdBsn = hospital.getElementsByTagName("wkdBsn")[0].textContent === '-' ? "정보 없음" : hospital.getElementsByTagName("wkdBsn")[0].textContent;
                        const wknBsn = hospital.getElementsByTagName("wknBsn")[0].textContent === '-' ? "정보 없음" : hospital.getElementsByTagName("wknBsn")[0].textContent;
                        const cls = hospital.getElementsByTagName("cls")[0].textContent || "정보 없음";
                        const position = new naver.maps.LatLng(lat, lng);

                        // 마커 생성
                        const marker = new naver.maps.Marker({
                            position: position,
                            map: map,
                            title: facility
                        });

                        // 인포윈도우 생성
                        const infoWindow = new naver.maps.InfoWindow({
                            content: `
                                <div class="info-window-content" style="width:200px;padding:10px;">
                                    <h4>${facility}</h4>
                                    <p><b>주소:</b> ${address}</p>
                                    <p><b>전화:</b> ${tel}</p>
                                    <p><b>평일 영업시간:</b> ${wkdBsn}</p>
                                    <p><b>주말 영업시간:</b> ${wknBsn}</p>
                                    <p><b>휴무일:</b> ${cls}</p>
                                </div>
                            `
                        });

                        // 마커 클릭 시 인포윈도우 표시
                        naver.maps.Event.addListener(marker, 'click', function() {
                            infoWindow.open(map, marker);
                        });

                        // 병원 목록에 추가
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `<strong>${facility}</strong><br>${address}<br>전화: ${tel}`;
                        listItem.onclick = function() {
                            map.setCenter(position);
                            infoWindow.open(map, marker);
                        };

                        // 현재 날짜에 따라 영업 여부 확인
                        const selectedDate = selectDateElement.value;
                        if (isOpen(hospital, selectedDate)) {
                            hospitalList.appendChild(listItem);
                        } else {
                            closedHospitalList.appendChild(listItem);
                        }

                        markers.push(marker);
                        infoWindows.push(infoWindow);
                    }
                } else {
                    console.log('검색 결과가 없습니다.');
                    hospitalList.innerHTML = '<li>검색 결과가 없습니다.</li>';
                }
            })
            .catch(error => {
                console.error('API 요청 중 오류 발생:', error);
            });

        // 사용자 설정 날짜 적용
        applyDateBtn.addEventListener('click', function() {
            const selectedDate = selectDateElement.value;
            hospitalList.innerHTML = '';  // 기존 목록 초기화
            closedHospitalList.innerHTML = '';  // 기존 영업 종료된 목록 초기화

            markers.forEach((marker, index) => {
                const hospital = xmlDoc.getElementsByTagName("list")[index];
                if (isOpen(hospital, selectedDate)) {
                    hospitalList.appendChild(marker);
                } else {
                    closedHospitalList.appendChild(marker);
                }
            });
        });

    </script>
    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/jquery.scrolly.min.js"></script>
    <script src="/assets/js/jquery.scrollex.min.js"></script>
    <script src="/assets/js/browser.min.js"></script>
    <script src="/assets/js/breakpoints.min.js"></script>
    <script src="/assets/js/util.js"></script>
    <script src="/assets/js/main.js"></script>
</body>
</html>
